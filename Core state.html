// Core state
let game = new Chess();
let board = null;
let isFlipped = false;
let pendingPromotion = null; // { from, to, color }
const redoStack = [];

// Elements
const turnEl = document.getElementById("turn");
const stateEl = document.getElementById("state");
const fenEl = document.getElementById("fen");
const moveListEl = document.getElementById("moveList");
const overlayEl = document.getElementById("overlay");
const checkFlagEl = document.getElementById("checkFlag");
const mateFlagEl = document.getElementById("mateFlag");
const drawFlagEl = document.getElementById("drawFlag");
const modalEl = document.getElementById("promotionModal");
const cancelPromotionEl = document.getElementById("cancelPromotion");

// Utilities
function algebraToIndex(square) {
  const file = square.charCodeAt(0) - 97; // a->0
  const rank = 8 - parseInt(square[1], 10); // 1->7, 8->0
  return { file, rank };
}
function clearOverlay() { overlayEl.innerHTML = ""; }
function makeOverlayCell(file, rank) {
  const cell = document.createElement("div");
  cell.className = "cell";
  cell.style.gridColumn = (file + 1);
  cell.style.gridRow = (rank + 1);
  return cell;
}

// Status updates
function updateStatus() {
  const moveColor = game.turn() === "w" ? "White" : "Black";
  let status = `${moveColor} to move`;

  checkFlagEl.textContent = game.in_check() ? "Yes" : "No";
  mateFlagEl.textContent = game.in_checkmate() ? "Yes" : "No";
  drawFlagEl.textContent = game.in_draw() ? "Yes" : "No";

  if (game.in_checkmate()) status = `Checkmate — ${moveColor === "White" ? "Black" : "White"} wins`;
  else if (game.in_stalemate()) status = "Stalemate";
  else if (game.in_threefold_repetition()) status = "Draw — threefold repetition";
  else if (game.insufficient_material()) status = "Draw — insufficient material";
  else if (game.in_draw()) status = "Draw";

  turnEl.textContent = status;
  stateEl.textContent = game.in_check() ? "Check" : "Ready";
  fenEl.textContent = game.fen();
}

// Move list
function resetMoves() { moveListEl.innerHTML = ""; }
function addMoveToList(move) {
  const li = document.createElement("li");
  li.textContent = move.san;
  moveListEl.appendChild(li);
  moveListEl.scrollTop = moveListEl.scrollHeight;
}
function rebuildMoveList() {
  resetMoves();
  const history = game.history({ verbose: true });
  history.forEach(m => addMoveToList(m));
}

// Highlights
let selectedSquare = null;
let lastMove = null;

function highlightSelected(square) {
  if (!square) return;
  const { file, rank } = algebraToIndex(square);
  const cell = makeOverlayCell(file, rank);
  const sel = document.createElement("div");
  sel.className = "select";
  cell.appendChild(sel);
  overlayEl.appendChild(cell);
}

function highlightLastMove() {
  if (!lastMove) return;
  const from = algebraToIndex(lastMove.from);
  const to = algebraToIndex(lastMove.to);

  [from, to].forEach(({ file, rank }) => {
    const cell = makeOverlayCell(file, rank);
    const lm = document.createElement("div");
    lm.className = "last";
    cell.appendChild(lm);
    overlayEl.appendChild(cell);
  });
}

function highlightLegalMoves(square) {
  const moves = game.moves({ square, verbose: true });
  moves.forEach(m => {
    const { file, rank } = algebraToIndex(m.to);
    const cell = makeOverlayCell(file, rank);
    if (m.flags.includes("c")) {
      const ring = document.createElement("div");
      ring.className = "ring";
      cell.appendChild(ring);
    } else {
      const dot = document.createElement("div");
      dot.className = "dot";
      cell.appendChild(dot);
    }
    overlayEl.appendChild(cell);
  });
}

function refreshHighlights() {
  clearOverlay();
  highlightSelected(selectedSquare);
  highlightLastMove();
  if (selectedSquare) highlightLegalMoves(selectedSquare);
}

// Promotion modal
function showPromotion(from, to, color) {
  pendingPromotion = { from, to, color };
  modalEl.classList.remove("hidden");
}
function hidePromotion() {
  pendingPromotion = null;
  modalEl.classList.add("hidden");
}
document.querySelectorAll(".promo-choices button").forEach(btn => {
  btn.addEventListener("click", () => {
    if (!pendingPromotion) return;
    const piece = btn.dataset.piece; // q r b n
    const move = game.move({
      from: pendingPromotion.from,
      to: pendingPromotion.to,
      promotion: piece
    });
    hidePromotion();
    if (move) {
      lastMove = move;
      redoStack.length = 0;
      board.position(game.fen());
      rebuildMoveList();
      updateStatus();
      refreshHighlights();
    }
  });
});
cancelPromotionEl.addEventListener("click", hidePromotion);

// Board interactions
function onDragStart(source, piece) {
  if (game.game_over()) return false;
  if ((game.turn() === "w" && piece.startsWith("b")) ||
      (game.turn() === "b" && piece.startsWith("w"))) return false;

  selectedSquare = source;
  refreshHighlights();
}

function onDrop(source, target) {
  const movingPiece = game.get(source);
  const isPawn = movingPiece && movingPiece.type === "p";
  const targetRank = target[1];

  if (isPawn && (targetRank === "8" || targetRank === "1")) {
    showPromotion(source, target, movingPiece.color);
    return "snapback";
  }

  const move = game.move({ from: source, to: target, promotion: "q" });
  if (move === null) return "snapback";

  lastMove = move;
  redoStack.length = 0;
  addMoveToList(move);
  updateStatus();
}

function onSnapEnd() {
  board.position(game.fen());
  selectedSquare = null;
  refreshHighlights();
}

function onSquareClick(square) {
  selectedSquare = selectedSquare === square ? null : square;
  refreshHighlights();
}

// Initialize board
function initBoard() {
  board = Chessboard("board", {
    position: "start",
    draggable: true,
    onDragStart,
    onDrop,
    onSnapEnd,
    onSquareClick
  });
  overlayEl.innerHTML = "";
  for (let r = 0; r < 8; r++) {
    for (let f = 0; f < 8; f++) {
      overlayEl.appendChild(makeOverlayCell(f, r));
    }
  }
  updateStatus();
  refreshHighlights();
}

// Controls
document.getElementById("newGame").addEventListener("click", () => {
  game.reset();
  lastMove = null;
  selectedSquare = null;
  redoStack.length = 0;
  board.start();
  resetMoves();
  updateStatus();
  refreshHighlights();
});

document.getElementById("undo").addEventListener("click", () => {
  const undone = game.undo();
  if (undone) {
    redoStack.push(undone);
    if (moveListEl.lastChild) moveListEl.removeChild(moveListEl.lastChild);
    lastMove = null;
    board.position(game.fen());
    updateStatus();
    refreshHighlights();
  }
});

document.getElementById("redo").addEventListener("click", () => {
  const move = redoStack.pop();
  if (!move) return;
  const redone = game.move(move);
  if (redone) {
    addMoveToList(redone);
    lastMove = redone;
    board.position(game.fen());
    updateStatus();
    refreshHighlights();
  } else {
    redoStack.push(move);
  }
});

document.getElementById("flip").addEventListener("click", () => {
  isFlipped = !isFlipped;
  board.flip();
});

document.getElementById("exportPGN").addEventListener("click", () => {
  const pgn = game.pgn();
  navigator.clipboard.writeText(pgn).then(() => {
    stateEl.textContent = "PGN copied";
    setTimeout(() => stateEl.textContent = game.in_check() ? "Check" : "Ready", 1500);
  });
});

// Boot
window.addEventListener("load", initBoard);
